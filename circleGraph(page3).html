<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>
    <style>
        #canvasText {
            width: 270px;
            height: 270px;
            display: inline-block;
            position: absolute;
            top: 10%;
            left: 10%;
        }
        
        #canvasShadow {
            width: 270px;
            height: 270px;
            display: inline-block;
            position: absolute;
            top: 10%;
            left: 10%;
        }
        
    </style>
</head>

<body>

    <canvas id="canvasShadow" width="540" height="540"></canvas>
    <canvas id="canvasText" width="540" height="540"></canvas>

    <script>
        var recommendSizeData = {
            recommendSize: 'M',
            isCorrectGender: true,
            recommendRate: 0,
            status: true,
            sizes: ['XS', 'S', 'M', 'L', 'XL']
        }

        var elIds = {
            canvasShadow: 'canvasShadow',
            canvasText: 'canvasText'
        }

        var recommendedSizeData = {
            sizeRate: recommendSizeData.recommendRate,
            sizeName: recommendSizeData.recommendSize,
            sizeIndex: recommendSizeData.sizes.indexOf(recommendSizeData.recommendSize),
            totalSizes: recommendSizeData.sizes,
            totalSizesLength: recommendSizeData.sizes.length
        };


        var getList = recommendedSizeData.totalSizes.filter(function (item, index) { // 
            var r = recommendedSizeData || {};

            if (r.sizeIndex === 0) {
                if (index < r.sizeIndex + 5) {
                    return item;
                }
            } else if (r.sizeIndex == 1) {
                if (index < r.sizeIndex + 4) {
                    return item;
                }
            } else if (r.sizeIndex == r.totalSizesLength - 1) {
                if (index > r.sizeIndex - 5) {
                    return item;
                }
            } else if (r.sizeIndex == r.totalSizesLength - 2) {
                if (index > r.sizeIndex - 4) {
                    return item;
                }
            } else {
                if (index > r.sizeIndex - 3 && index < r.sizeIndex + 3) {
                    return item;
                }
            }
        });
        

        var recommendedRateValue = function () {
            var r = recommendedSizeData || {};

            if (r.totalSizesLength == 5) {

                if (r.sizeRate >= 3 && r.sizeRate > 0 || r.sizeRate < 0 && r.sizeRate <= -3) {
                    return 1;
                } else {
                    return 0;
                }

            } else if (r.totalSizesLength == 4) {

                if (r.sizeRate <= 3 && r.sizeRate > 0 || r.sizeRate < 0 && r.sizeRate >= -3) {
                    return 1;
                } else if (r.sizeRate >= 4 && r.sizeRate > 0 || r.sizeRate < 0 && r.sizeRate <= -4) {
                    return 2;
                } else {
                    return 0;
                }

            } else if (r.totalSizesLength == 3) {

                if (r.sizeRate <= 2 && r.sizeRate > 0 || r.sizeRate < 0 && r.sizeRate >= -2) {
                    return 1;
                } else if (r.sizeRate == 3 && r.sizeRate > 0 || r.sizeRate < 0 && r.sizeRate == -3) {
                    return 2;
                } else if (r.sizeRate >= 4 && r.sizeRate > 0 || r.sizeRate < 0 && r.sizeRate <= -4) {
                    return 3;
                } else {
                    return 0;
                }

            } else if (r.totalSizesLength == 2) {
                return r.sizeRate;
            }

        };

        function initCircleGraph(canvas) {
            var shadowCanvas = document.getElementById(canvas.canvasShadow);
            var textCanvas = document.getElementById(canvas.canvasText);
            var textContext = textCanvas.getContext("2d");
            var shadowContext = shadowCanvas.getContext("2d");

            var circleGraphControl = {
                motionValue: 100,
                shadowBlurGene: 50,
                textSize: 32,
                textColor: '#F6F5F3',
                BrightTextColor: '#20607A',
                pointerText: 'ME!',
                pointerSize: 28,
                pointerTextColor: '#00FFB0',
                circleColor: '#ffffff',
                shadowReversalIn: false,
                shadowReversalOut: true
            }

            return {
                textCanvas: textCanvas,
                textContext: textContext,
                shadowCanvas: shadowCanvas,
                shadowContext: shadowContext,
                circleGraphControl: circleGraphControl
            };
        };

        function calCircleGraphLocation(canvasInfo, sizeList) {
            var c = canvasInfo || {};
            var r = recommendedSizeData || {};
            
            var piePieceCount = 5;
            var piePieceAllMotion = 18 * c.circleGraphControl.motionValue;
            var piePieceMotion = piePieceCount * c.circleGraphControl.motionValue;
            var drawRadian = ((2 * Math.PI) / piePieceAllMotion) * piePieceMotion;
            var calculatedsizeIndex = (Math.PI / 18) * (r.sizeIndex * 6 +3);
            
            var canvasHalfWidth = c.shadowCanvas.width / 2;
            var radius = c.textCanvas.height / 2;
            var pointerRadius = c.textCanvas.height / 4;

            return {
                canvas: c.shadowCanvas,
                shadowContext: c.shadowContext,
                textContext: c.textContext,
                canvasHalfWidth: canvasHalfWidth,
                drawRadian: drawRadian,
                radius: radius,
                pointerRadius: pointerRadius,
                calculatedsizeIndex: calculatedsizeIndex,
                sizeList: sizeList,
            };
        }

        function drawCircleGraphShadow(canvasInfo, rateIncreaseCount, locationValueInfo) {
            var l = locationValueInfo || {};
            var t = canvasInfo.circleGraphControl || {};
            var r = recommendedSizeData || {};
            var stratPoint;
            var startValue = 0.4;
            var blurIncrease = 0;
            var increaseCount = rateIncreaseCount / 10;

            stratPoint = (startValue * Math.PI) + l.calculatedsizeIndex;

            var pieGraphInterval = setInterval(function () {
                l.shadowContext.clearRect(0, 0, l.canvas.width, l.canvas.height);

                l.shadowContext.beginPath();
                l.shadowContext.moveTo(l.canvasHalfWidth, l.canvasHalfWidth);
                l.shadowContext.arc(l.canvasHalfWidth, l.canvasHalfWidth, l.canvasHalfWidth / 1.35 , stratPoint, stratPoint + l.drawRadian, t.shadowReversalIn);
                l.shadowContext.shadowColor = "rgba(32,96,122," + blurIncrease + ")";
                l.shadowContext.shadowBlur = t.shadowBlurGene;
                l.shadowContext.closePath();
                l.shadowContext.fillStyle = t.circleColor;
                l.shadowContext.fill();

                l.shadowContext.beginPath();
                l.shadowContext.moveTo(l.canvasHalfWidth, l.canvasHalfWidth);
                l.shadowContext.arc(l.canvasHalfWidth, l.canvasHalfWidth, l.canvasHalfWidth / 1.35, stratPoint, stratPoint + l.drawRadian, t.shadowReversalOut);
                l.shadowContext.shadowColor = "rgba(227,237,168," + blurIncrease + ")";
                l.shadowContext.shadowBlur = t.shadowBlurGene;
                l.shadowContext.fillStyle = t.circleColor;
                l.shadowContext.fill();

                l.shadowContext.beginPath();
                l.shadowContext.arc(l.canvasHalfWidth, l.canvasHalfWidth, l.canvasHalfWidth - 70, 0, 2 * Math.PI);
                l.shadowContext.shadowBlur = 0;
                l.shadowContext.fillStyle = t.circleColor;
                l.shadowContext.fill();

                blurIncrease += 0.05;

                if (blurIncrease > 1) {
                    clearInterval(pieGraphInterval);
                }
            }, t.motionValue);
        };

        function drawRecommendSizeText(canvasInfo, rateIncreaseCount, locationValueInfo) {
            var s = this;
            var l = locationValueInfo || {};
            var r = recommendedSizeData || {};
            var t = canvasInfo.circleGraphControl || {};
            var recommendSizeLocationCount = [];
            var recommendSizePointerValue;
            var recommendSizePointerText;
            var rateIncrease = rateIncreaseCount;
            var rateDecrease = -rateIncreaseCount;
            var rangeCount = 3;
            var avgCount = 3;

            for (var i = 0; i < 13; i++) {
                recommendSizeLocationCount[i] = i + 3;
            }

            if (r.totalSizesLength == 4) {
                avgCount = 4;
            } else if (r.totalSizesLength == 3) {
                rangeCount = 4;
                avgCount = 6;
            } else if (r.totalSizesLength == 2) {
                rangeCount = 6;
                avgCount = 12;
            }

            var recommendedSizeList = recommendSizeLocationCount.filter(function (item, index) {
                if (index % avgCount === 0) {
                    return item;
                }
            });

            var recommendedSizeRangeList = recommendSizeLocationCount.filter(function (item, index) {
                if (index % avgCount !== 0) {
                    return item;
                }
            });

            var pointerIndexValue = recommendedSizeList.filter(function (item, index) {
                if (index == r.sizeIndex) {
                    recommendSizePointerText = item;

                    if (r.sizeRate >= 0) {
                        recommendSizePointerValue = item + rateIncrease;
                    } else if (r.sizeRate < 0) {
                        recommendSizePointerValue = item + rateDecrease;
                    }
                }
            });

            var rangeValue = recommendSizeLocationCount.filter(function (item) {
                if (recommendSizePointerValue - rangeCount < item && item < recommendSizePointerValue + rangeCount) {
                    return item;
                }
            });

            s.drawCircleGraphText = function () {
                var sizeTextAngle, dotTextAngle;
                var labelCount = 0;

                l.textContext.translate(l.radius, l.radius);
                l.radius = l.radius * 0.79;

                l.textContext.beginPath();
                l.textContext.arc(0, 0, l.radius / 1.06, 0, 2 * Math.PI);
                l.textContext.fillStyle = t.circleColor;
                l.textContext.fill();

                l.textContext.font = "" + t.textSize + "px arial";
                l.textContext.textAlign = "center";
                l.textContext.fillStyle = t.textColor;

                for (var i = 0, length = recommendedSizeList.length; i < length; i++) {
                    sizeTextAngle = (recommendedSizeList[i] + 9) * Math.PI / 9;

                    l.textContext.rotate(sizeTextAngle);
                    l.textContext.translate(0, -l.radius * 0.8);
                    l.textContext.rotate(-sizeTextAngle);

                    l.textContext.fillText(l.sizeList[labelCount], 0, 0);

                    l.textContext.rotate(sizeTextAngle);
                    l.textContext.translate(0, l.radius * 0.8);
                    l.textContext.rotate(-sizeTextAngle);

                    labelCount++;
                }

                for (var i = 0, length = recommendedSizeRangeList.length; i < length; i++) {
                    dotTextAngle = (recommendedSizeRangeList[i] + 9) * Math.PI / 9;

                    l.textContext.rotate(dotTextAngle);
                    l.textContext.translate(0, -l.radius * 0.8);
                    l.textContext.rotate(-dotTextAngle);

                    l.textContext.fillText(".", 0, 0);

                    l.textContext.rotate(dotTextAngle);
                    l.textContext.translate(0, l.radius * 0.8);
                    l.textContext.rotate(-dotTextAngle);
                }
            };

            s.drawCircleGraphColorText = function () {
                var intervalCount = 0;
                var pointerTextCount = 0;
                var intervalStopCount = 0;

                var colorTextInterval = setInterval(function () {

                    var circleLocationValue = rangeValue[intervalCount];
                    var textIndex = recommendedSizeList.indexOf(circleLocationValue);
                    var lightTextAngle = (circleLocationValue + 9) * Math.PI / 9;

                    var sizeTextLocation = recommendedSizeList.filter(function (item) {
                        if (circleLocationValue == item) {
                            return item;
                        }
                    });

                    l.textContext.rotate(lightTextAngle);
                    l.textContext.translate(0, -l.radius * 0.8);
                    l.textContext.rotate(-lightTextAngle);

                    l.textContext.fillStyle = t.BrightTextColor;

                    if (typeof circleLocationValue !== 'undefined') {

                        if (r.totalSizesLength == 2) {

                            if (intervalCount < 13) {
                                if (circleLocationValue == sizeTextLocation) {
                                    l.textContext.clearRect(-20, -25, 45, 30);
                                    l.textContext.fillText(l.sizeList[textIndex], 0, 0);
                                } else {
                                    l.textContext.clearRect(-lightTextAngle, -lightTextAngle, 20, 20);
                                    l.textContext.fillText(".", 0, 0);
                                }
                            }

                        } else if (r.totalSizesLength == 3) {

                            if (intervalCount < 7) {
                                if (circleLocationValue == sizeTextLocation) {
                                    l.textContext.clearRect(-20, -25, 45, 30);
                                    l.textContext.fillText(l.sizeList[textIndex], 0, 0);
                                } else {
                                    l.textContext.clearRect(-lightTextAngle, -lightTextAngle, 20, 20);
                                    l.textContext.fillText(".", 0, 0);
                                }
                            }

                        } else {

                            if (intervalCount < 5) {
                                if (circleLocationValue == sizeTextLocation) {
                                    l.textContext.clearRect(-20, -25, 45, 30);
                                    l.textContext.fillText(l.sizeList[textIndex], 0, 0);
                                } else {
                                    l.textContext.clearRect(-lightTextAngle, -lightTextAngle, 20, 20);
                                    l.textContext.fillText(".", 0, 0);
                                }
                            }

                        }

                        l.textContext.rotate(lightTextAngle);
                        l.textContext.translate(0, l.radius * 0.8);
                        l.textContext.rotate(-lightTextAngle);

                        intervalCount++;

                    } else {
                        pointerTextCount++;
                    }

                    if (pointerTextCount == 1) {
                        s.drawPointerSizeText();
                        intervalStopCount++;
                    } else if (intervalStopCount == 1) {
                        s.drawPointerDotText();
                        clearInterval(colorTextInterval);
                    }

                }, t.motionValue);
            };

            s.drawPointerSizeText = function () {
                var colorTextIndex = recommendedSizeList.indexOf(recommendSizePointerText);
                var pointerAngle = (recommendSizePointerText + 9) * Math.PI / 9;

                l.textContext.translate(0, l.radius / 1.25);

                l.textContext.rotate(pointerAngle);
                l.textContext.translate(0, -l.radius * 0.8);
                l.textContext.rotate(-pointerAngle);

                l.textContext.clearRect(-20, -25, 45, 30);
                l.textContext.fillStyle = t.pointerTextColor;
                l.textContext.fillText(l.sizeList[colorTextIndex], 0, 0);

                l.textContext.rotate(pointerAngle);
                l.textContext.translate(0, l.radius * 0.8);
                l.textContext.rotate(-pointerAngle);
            };

            s.drawPointerDotText = function () {
                var pointerAngle = (recommendSizePointerValue + 9) * Math.PI / 9;

                l.textContext.translate(0, l.radius / 1.25);

                l.textContext.rotate(pointerAngle);
                l.textContext.translate(0, -l.pointerRadius * 1.8);
                l.textContext.rotate(-pointerAngle);

                l.textContext.font = "" + t.pointerSize + "px arial";
                l.textContext.fillStyle = t.pointerTextColor;
                l.textContext.fillText(t.pointerText, 0, 5);

                l.textContext.rotate(pointerAngle);
                l.textContext.translate(0, l.pointerRadius * 1.8);
                l.textContext.rotate(-pointerAngle);
            };

            s.drawCircleGraphText();
            s.drawCircleGraphColorText();

        };

        function drawCircleGraph() {
            var canvasInfo = initCircleGraph(elIds);
            var rateIncreaseValue = recommendedRateValue();
            var circleGraphLocationValue = calCircleGraphLocation(canvasInfo, getList, recommendedSizeData.sizeName);

            drawCircleGraphShadow(canvasInfo, rateIncreaseValue, circleGraphLocationValue);
            drawRecommendSizeText(canvasInfo, rateIncreaseValue, circleGraphLocationValue);
        }

        drawCircleGraph();
    </script>
</body>

</html>